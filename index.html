<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>tab</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
  <div class="hdr">
    <div class="wordmark">tab<em>.</em></div>
    <div class="hdr-r">
      <div class="mnav">
        <button class="marrow" onclick="changeMonth(-1)">&#8249;</button>
        <div class="mlabel" id="mlabel">---</div>
        <button class="marrow" onclick="changeMonth(1)">&#8250;</button>
      </div>
      <div class="hbtn" id="dbgbtn" onclick="toggleDbg()">&#128269;</div>
      <div class="hbtn" id="refbtn" onclick="loadData()">&#8635;</div>
    </div>
  </div>
  
  <div class="pw" id="pw">
    <div class="pages" id="pages">
      <!-- Tab 0: Home -->
      <div class="page" id="p0">
        <div class="pi" id="hc">
          <div class="sc">
            <div class="pr"><div class="pdot"></div></div>
            <div class="stext">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Tab 1: Plan -->
      <div class="page" id="p1">
        <div class="pi" id="pc">
          <div class="sc">
            <div class="pr"><div class="pdot"></div></div>
            <div class="stext">Loading budget...</div>
          </div>
        </div>
      </div>
      
      <!-- Tab 2: Spending -->
      <div class="page" id="p2">
        <div class="pi" id="sc2">
          <div class="sc">
            <div class="pr"><div class="pdot"></div></div>
            <div class="stext">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Tab 3: Accounts -->
      <div class="page" id="p3">
        <div class="pi" id="ac">
          <div class="sc">
            <div class="pr"><div class="pdot"></div></div>
            <div class="stext">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Tab 4: More -->
      <div class="page" id="p4">
        <div class="pi" id="mc">
          <div class="sc">
            <div class="pr"><div class="pdot"></div></div>
            <div class="stext">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="tabbar">
    <div class="tab active" data-tab="0" onclick="switchTab(0)">
      <div class="ti">
        <svg viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
      </div>
      <div class="tlabel">Home</div>
    </div>
    
    <div class="tab" data-tab="1" onclick="switchTab(1)">
      <div class="ti" style="position:relative">
        <svg viewBox="0 0 24 24">
          <rect x="3" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
        <span class="tbadge" id="planbadge" style="display:none">0</span>
      </div>
      <div class="tlabel">Plan</div>
    </div>
    
    <div class="tab" data-tab="2" onclick="switchTab(2)">
      <div class="ti">
        <svg viewBox="0 0 24 24">
          <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
        </svg>
      </div>
      <div class="tlabel">Spending</div>
    </div>
    
    <div class="tab" data-tab="3" onclick="switchTab(3)">
      <div class="ti">
        <svg viewBox="0 0 24 24">
          <rect x="2" y="5" width="20" height="14" rx="2"/>
          <path d="M2 10h20"/>
        </svg>
      </div>
      <div class="tlabel">Accounts</div>
    </div>
    
    <div class="tab" data-tab="4" onclick="switchTab(4)">
      <div class="ti">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="1"/>
          <circle cx="19" cy="12" r="1"/>
          <circle cx="5" cy="12" r="1"/>
        </svg>
      </div>
      <div class="tlabel">More</div>
    </div>
  </div>
</div>

<!-- Debug Panel -->
<div class="dbg hidden" id="dbgpanel">
  <div class="dbghdr">
    <div class="dbgtitle">&#128269; Debug</div>
    <button class="dbgclose" onclick="toggleDbg()">Close</button>
  </div>
  <div class="dbgtabs">
    <div class="dbgtab active" onclick="switchDbgTab(0)" id="dt0">Overview</div>
    <div class="dbgtab" onclick="switchDbgTab(1)" id="dt1">Budget</div>
    <div class="dbgtab" onclick="switchDbgTab(2)" id="dt2">Activity</div>
    <div class="dbgtab" onclick="switchDbgTab(3)" id="dt3">Snapshot</div>
  </div>
  <div class="dbgbody" id="dbgbody">
    <div class="dbgempty">Load data first.</div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════════════════
   CONSTANTS
   ══════════════════════════════════════════════════════════════════════════ */

var WEBHOOK = 'https://script.google.com/macros/s/AKfycbxy2zzSSdVP4zoLO8em6hUkAnNran5lq2_U1QIbMgVRutHuVeE_KBRzkRiEbc9X7GeMQA/exec';

var ACCOUNTS = [
  'BDO', 'BPI', 'Cash', 'GCash', 'Maribank', 'Maya', 'UnionBank', 'UnionBank Credit'
];

var MONTHS = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'
];

var GORDER = [
  'Income', 'Home', 'Pets', 'Health', 'Quality Of Life',
  'Stellar Rebels', 'Sinking', 'Emergency', 'Goals'
];


/* ══════════════════════════════════════════════════════════════════════════
   STATE
   ══════════════════════════════════════════════════════════════════════════ */

var viewMonth = new Date();
viewMonth.setDate(1);

var curTab = 0;
var rawB = null;
var rawA = null;
var rawS = null;
var rawAS = null;
var parsed = null;
var lastUp = null;

var dismissed = {};
var spendFilter = 'All';
var accDet = null;
var dbgOpen = false;
var dbgTab = 0;


/* ══════════════════════════════════════════════════════════════════════════
   UTILITY FUNCTIONS
   ══════════════════════════════════════════════════════════════════════════ */

function parseDate(v) {
  if (v == null || v === undefined) return null;
  if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
  
  var s = String(v).trim();
  if (!s || s === '-' || s === '--') return null;
  
  // Skip text headers like "MonthStart"
  if (/^[A-Za-z]/.test(s)) return null;
  
  // ISO timestamp with time component — e.g. "2026-01-31T16:00:00.000Z"
  // Apps Script sends dates as UTC timestamps; must convert to LOCAL time
  // so that 2026-01-31T16:00:00Z = Feb 1 in UTC+8 is treated as February.
  if (s.indexOf('T') > -1) {
    var ts = new Date(s);
    if (!isNaN(ts.getTime())) {
      return new Date(ts.getFullYear(), ts.getMonth(), ts.getDate());
    }
    return null;
  }
  
  // MM/DD/YYYY
  var m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return new Date(+m[3], +m[1] - 1, +m[2]);
  
  // YYYY-MM-DD (date only, no time — treat as local)
  var m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m2) return new Date(+m2[1], +m2[2] - 1, +m2[3]);
  
  // Google Sheets serial (e.g. 45321)
  if (/^\d+$/.test(s)) {
    var n = parseInt(s, 10);
    if (n > 40000 && n < 60000) {
      var e = new Date(Date.UTC(1899, 11, 30) + n * 86400000);
      return new Date(e.getUTCFullYear(), e.getUTCMonth(), e.getUTCDate());
    }
  }
  
  var d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}

function pn(v) {
  if (typeof v === 'number') return v;
  return parseFloat(String(v || '0').replace(/[^0-9.\-]/g, '')) || 0;
}

function peso(n) {
  return '\u20b1' + Math.abs(n).toLocaleString('en-PH', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function sh(n) {
  var a = Math.abs(n);
  if (a >= 1e6) return '\u20b1' + (a / 1e6).toFixed(1) + 'M';
  if (a >= 1e3) return '\u20b1' + (a / 1e3).toFixed(1) + 'k';
  return '\u20b1' + a.toFixed(0);
}

function fd(d) {
  if (!d) return '--';
  return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });
}

function esc(s) {
  return s.replace(/'/g, "\\'");
}

function haptic() {
  try {
    if (navigator.vibrate) navigator.vibrate(22);
  } catch (e) {}
}

// Header detection — returns true if first row is a header (not a date)
function bHdr(rows) {
  if (!rows || !rows.length) return false;
  return !parseDate(String(rows[0][5] || ''));
}

function aHdr(rows) {
  if (!rows || !rows.length) return false;
  return !parseDate(String(rows[0][0] || ''));
}

function sHdr(rows) {
  if (!rows || !rows.length) return false;
  return !parseDate(String(rows[0][0] || ''));
}


/* ══════════════════════════════════════════════════════════════════════════
   TOUCH HANDLERS
   ══════════════════════════════════════════════════════════════════════════ */

var tx0 = 0, ty0 = 0, pullY = 0, pulling = false;
var pw = document.getElementById('pw');

pw.addEventListener('touchstart', function(e) {
  tx0 = e.touches[0].clientX;
  ty0 = e.touches[0].clientY;
  pullY = e.touches[0].clientY;
}, { passive: true });

pw.addEventListener('touchend', function(e) {
  var dx = e.changedTouches[0].clientX - tx0;
  var dy = e.changedTouches[0].clientY - ty0;
  
  if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 48) {
    if (dx < 0 && curTab < 4) switchTab(curTab + 1);
    if (dx > 0 && curTab > 0) switchTab(curTab - 1);
  }
  
  pulling = false;
}, { passive: true });

pw.addEventListener('touchmove', function(e) {
  var page = document.getElementById('p' + curTab);
  if (page && page.scrollTop === 0 && (e.touches[0].clientY - pullY) > 72 && !pulling) {
    pulling = true;
    loadData();
  }
}, { passive: true });


/* ══════════════════════════════════════════════════════════════════════════
   MONTH NAVIGATION
   ══════════════════════════════════════════════════════════════════════════ */

function setML() {
  document.getElementById('mlabel').textContent = 
    MONTHS[viewMonth.getMonth()].slice(0, 3).toUpperCase() + ' ' + viewMonth.getFullYear();
}

function changeMonth(d) {
  viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth() + d, 1);
  setML();
  if (rawB) {
    parsed = parseAll();
    renderCur();
  }
}


/* ══════════════════════════════════════════════════════════════════════════
   TAB SWITCHING
   ══════════════════════════════════════════════════════════════════════════ */

function switchTab(idx) {
  curTab = idx;
  document.querySelectorAll('.tab').forEach(function(t) {
    t.classList.toggle('active', +t.dataset.tab === idx);
  });
  document.getElementById('pages').style.transform = 'translateX(-' + (idx * 20) + '%)';
  if (parsed) renderCur();
}

function renderCur() {
  accDet = null;
  if (curTab === 0) renderHome();
  else if (curTab === 1) renderPlan();
  else if (curTab === 2) renderSpend();
  else if (curTab === 3) renderAccounts();
  else if (curTab === 4) renderMore();
}


/* ══════════════════════════════════════════════════════════════════════════
   DATA LOADING
   ══════════════════════════════════════════════════════════════════════════ */

function loadData() {
  var btn = document.getElementById('refbtn');
  btn.style.opacity = '0.35';
  btn.style.pointerEvents = 'none';
  
  fetch(WEBHOOK)
    .then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function(j) {
      if (j.status === 'error') throw new Error(j.message);
      if (!j.budget || !j.activity || !j.snapshot) {
        throw new Error('Missing tabs in response');
      }
      
      rawB = j.budget;
      rawA = j.activity;
      rawS = j.snapshot;
      rawAS = j.accountSnapshot || null;
      lastUp = new Date();
      
      parsed = parseAll();
      renderCur();
      if (dbgOpen) renderDbg();
      
      try {
        localStorage.setItem('tab_v1', JSON.stringify({
          b: rawB,
          a: rawA,
          s: rawS,
          as: rawAS,
          ts: lastUp.toISOString()
        }));
      } catch (e) {}
    })
    .catch(function(e) {
      showErr(e.message);
    })
    .finally(function() {
      btn.style.opacity = '';
      btn.style.pointerEvents = '';
    });
}

function loadCache() {
  try {
    var c = JSON.parse(localStorage.getItem('tab_v1') || 'null');
    if (!c) return false;
    
    rawB = c.b;
    rawA = c.a;
    rawS = c.s;
    rawAS = c.as || null;
    lastUp = new Date(c.ts);
    
    parsed = parseAll();
    renderCur();
    return true;
  } catch (e) {
    return false;
  }
}

function showErr(msg) {
  var h = '<div class="sc"><div class="etitle">Load failed</div>' +
    '<div class="stext">' + msg + '</div>' +
    '<button class="btn-retry" onclick="loadData()">Retry</button></div>';
  
  ['hc', 'pc'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.innerHTML = h;
  });
}


/* ══════════════════════════════════════════════════════════════════════════
   DATA PARSING — ⚠️ COLUMN MAPPING IS WRONG, NEEDS FIX
   ══════════════════════════════════════════════════════════════════════════ */

function parseAll() {
  var vm = viewMonth.getMonth();
  var vy = viewMonth.getFullYear();
  
  var bData = bHdr(rawB) ? rawB.slice(1) : rawB;
  var aData = aHdr(rawA) ? rawA.slice(1) : rawA;
  var sData = sHdr(rawS) ? rawS.slice(1) : rawS;
  
  // Budget rows for this month — filter by col 5 (MonthStart date)
  var bRows = bData.filter(function(row) {
    var d = parseDate(row[5]);
    return d && d.getMonth() === vm && d.getFullYear() === vy;
  });
  
  // ⚠️ CRITICAL BUG: Column mapping is WRONG
  // Current code uses row[12] as totalAssigned and row[13] as activity
  // CORRECT mapping should be:
  //   row[11] = AssignedThisMonth (includes rollovers) → "Budgeted"
  //   row[12] = Activity (negative = spend) → "Spent"
  //   row[14] = AvailableThisMonth → "Available" (hero)
  
  var catMap = {};
  bRows.forEach(function(row) {
    var grp = String(row[6] || '').trim();
    var cat = String(row[7] || '').trim();
    if (!cat || !grp) return;
    
    catMap[cat] = {
      group: grp,
      yearlyGoal: pn(row[8]),       // YearlyGoal (col I) — used in Home tab Goals section
      monthlyGoal: pn(row[9]),      // MonthlyGoal (col J) — used in Plan tab for Sinking/Emergency/Goals
      assigned: pn(row[10]),
      totalAssigned: pn(row[11]),  // ✅ CORRECT - AssignedThisMonth (includes rollovers)
      activity: pn(row[12]),        // ✅ CORRECT - Activity (negative = spent)
      rollover: pn(row[13]),        // RolloverPrevMonth
      available: pn(row[14]),       // AvailableThisMonth (hero)
      overspent: pn(row[15])
    };
  });
  
  // Snapshot for this month
  var rta = 0, atm = 0, inflowExt = 0, outflowExt = 0, cashEnd = 0;
  var prevCashEnd = 0;
  var sMonths = sData.map(function(sr) {
    return { d: parseDate(sr[0]), row: sr };
  }).filter(function(x) { return x.d; }).sort(function(a, b) { return b.d - a.d; });
  
  for (var i = 0; i < sMonths.length; i++) {
    var sm = sMonths[i];
    if (sm.d.getMonth() === vm && sm.d.getFullYear() === vy) {
      var sr = sm.row;
      inflowExt = pn(sr[2]);
      atm = pn(sr[3]);
      outflowExt = pn(sr[4]);
      cashEnd = pn(sr[5]);   // CashEnd = total net worth this month
      rta = pn(sr[6]);       // ReadyToAssignEnd (hero)
      // Find previous month
      if (sMonths[i + 1]) prevCashEnd = pn(sMonths[i + 1].row[5]);
      break;
    }
  }
  
  // Activity — filter by col 0 (transaction Date), NOT col 11
  var monthAct = aData.filter(function(row) {
    var d = parseDate(row[0]);
    return d && d.getMonth() === vm && d.getFullYear() === vy;
  });
  
  var balRows = aData.filter(function(row) {
    return String(row[1]).trim() === 'Balance';
  });
  
  var expRows = monthAct.filter(function(r) {
    return String(r[1]).trim() === 'Expense';
  });
  
  var incRows = monthAct.filter(function(r) {
    return String(r[1]).trim() === 'Income';
  });
  
  var totalInc = incRows.reduce(function(s, r) {
    return s + Math.abs(pn(r[2]));
  }, 0);
  
  var totalExp = expRows.reduce(function(s, r) {
    return s + Math.abs(pn(r[2]));
  }, 0);
  
  // Transactions per category
  var txnsByCat = {};
  expRows.forEach(function(row) {
    var cat = String(row[5] || '').trim();
    if (!cat) return;
    if (!txnsByCat[cat]) txnsByCat[cat] = [];
    txnsByCat[cat].push({
      date: parseDate(row[0]),
      type: 'expense',
      amount: pn(row[2]),
      merchant: String(row[3] || '').trim(),
      payment: String(row[4] || '').trim(),
      cat: cat,
      group: String(row[6] || '').trim(),
      memo: String(row[7] || '').trim()
    });
  });
  
  // Build categories
  var categories = [];
  Object.keys(catMap).forEach(function(cat) {
    var d = catMap[cat];
    var actAmt = Math.abs(d.activity);
    var ta = d.totalAssigned;
    var pct = ta > 0 ? Math.min((actAmt / ta) * 100, 100) : (actAmt > 0 ? 100 : 0);
    var status = d.available < 0 ? 'over' : 
                 pct >= 80 ? 'warn' : 
                 (d.available === 0 && ta === 0) ? 'zero' : 'ok';
    
    var txns = (txnsByCat[cat] || []).sort(function(a, b) {
      return b.date - a.date;
    });
    
    categories.push({
      cat: cat,
      group: d.group,
      yearlyGoal: d.yearlyGoal,
      monthlyGoal: d.monthlyGoal,
      assigned: d.assigned,
      totalAssigned: ta,
      activity: d.activity,
      actAmt: actAmt,
      rollover: d.rollover,
      available: d.available,
      overspent: d.overspent,
      pct: pct,
      status: status,
      txns: txns
    });
  });
  
  // Account balances from AccountSnapshot (current month) — preferred source
  // Falls back to Balance rows from Activity if accountSnapshot not available
  var accountSnap = {};
  // Note: cashEnd already set from MonthSnapshot above — do not re-declare here
  
  if (rawAS && rawAS.length) {
    var asData = rawAS;
    // Skip header row if present (first cell is not a date)
    if (!parseDate(String(rawAS[0][0] || ''))) asData = rawAS.slice(1);
    
    asData.forEach(function(row) {
      var d = parseDate(row[0]);
      if (d && d.getMonth() === vm && d.getFullYear() === vy) {
        var acc = String(row[1] || '').trim();
        if (acc) {
          accountSnap[acc] = {
            cashStart: pn(row[2]),
            activity: pn(row[3]),
            cashEnd: pn(row[4])
          };
        }
      }
    });
  }
  
  // Account balances from ALL-TIME Balance rows (fallback / used for txn account detail)
  var accBals = {};
  ACCOUNTS.forEach(function(acc) {
    if (accountSnap[acc]) {
      // Use AccountSnapshot CashEnd if available
      accBals[acc] = accountSnap[acc].cashEnd;
    } else {
      // Fallback: latest Balance row from Activity
      var rows = balRows
        .filter(function(r) { return String(r[4] || '').trim() === acc; })
        .sort(function(a, b) {
          var da = parseDate(a[0]) || new Date(0);
          var db = parseDate(b[0]) || new Date(0);
          return db - da;
        });
      accBals[acc] = rows.length ? pn(rows[0][2]) : 0;
    }
  });
  
  
  // Transactions by account this month
  var txnsByAcc = {};
  ACCOUNTS.forEach(function(acc) {
    txnsByAcc[acc] = monthAct
      .filter(function(r) {
        return String(r[4] || '').trim() === acc && 
               String(r[1]).trim() !== 'Balance';
      })
      .map(function(r) {
        return {
          date: parseDate(r[0]),
          type: String(r[1]).trim().toLowerCase(),
          amount: pn(r[2]),
          merchant: String(r[3] || '').trim(),
          payment: acc,
          cat: String(r[5] || '').trim(),
          group: String(r[6] || '').trim(),
          memo: String(r[7] || '').trim()
        };
      })
      .sort(function(a, b) { return b.date - a.date; });
  });
  
  // All month transactions (Spending tab)
  var allTxns = monthAct
    .filter(function(r) { return String(r[1]).trim() !== 'Balance'; })
    .map(function(r) {
      return {
        date: parseDate(r[0]),
        type: String(r[1]).trim().toLowerCase(),
        amount: pn(r[2]),
        merchant: String(r[3] || '').trim(),
        payment: String(r[4] || '').trim(),
        cat: String(r[5] || '').trim(),
        group: String(r[6] || '').trim(),
        memo: String(r[7] || '').trim()
      };
    })
    .sort(function(a, b) { return b.date - a.date; });
  
  var overspent = categories.filter(function(c) {
    return c.available < 0;
  });
  
  var totalAssignedAll = bRows.reduce(function(s, row) {
    return s + pn(row[11]);  // ✅ CORRECT - AssignedThisMonth
  }, 0);
  
  // Top 5 transactions
  var top5 = expRows.slice()
    .sort(function(a, b) {
      return Math.abs(pn(a[2])) - Math.abs(pn(b[2]));
    })
    .slice(-5)
    .reverse()
    .map(function(r) {
      return {
        merchant: String(r[3] || '').trim(),
        cat: String(r[5] || '').trim(),
        memo: String(r[7] || '').trim(),
        amount: Math.abs(pn(r[2]))
      };
    });
  
  // Top merchants
  var mMap = {};
  expRows.forEach(function(r) {
    var mn = String(r[3] || '').trim() || '--';
    if (!mMap[mn]) mMap[mn] = { total: 0, count: 0 };
    mMap[mn].total += Math.abs(pn(r[2]));
    mMap[mn].count++;
  });
  
  var merch = Object.keys(mMap)
    .sort(function(a, b) { return mMap[b].total - mMap[a].total; })
    .slice(0, 10)
    .map(function(n) {
      return {
        name: n,
        total: mMap[n].total,
        count: mMap[n].count
      };
    });
  
  return {
    categories: categories,
    overspent: overspent,
    readyToAssign: rta,
    assignedThisMonth: atm,
    inflowExt: inflowExt,
    outflowExt: outflowExt,
    totalInc: totalInc,
    totalExp: totalExp,
    totalAssignedAll: totalAssignedAll,
    accBals: accBals,
    accountSnap: accountSnap,
    cashEnd: cashEnd,
    prevCashEnd: prevCashEnd,
    netWorth: cashEnd || Object.values(accBals).reduce(function(s, v) { return s + v; }, 0),
    txnsByAcc: txnsByAcc,
    allTxns: allTxns,
    top5: top5,
    merch: merch,
    _bData: bData,
    _aData: aData,
    _sData: sData,
    _bRows: bRows,
    _mAct: monthAct,
    _dbg: {
      bHdr: bHdr(rawB),
      aHdr: aHdr(rawA),
      sHdr: sHdr(rawS),
      rawB: rawB.length,
      rawA: rawA.length,
      rawS: rawS.length,
      bMo: bRows.length,
      aMo: monthAct.length,
      cats: categories.length,
      expCt: expRows.length,
      incCt: incRows.length,
      balCt: balRows.length,
      hasAccSnap: Object.keys(accountSnap).length > 0
    }
  };
}


/* ══════════════════════════════════════════════════════════════════════════
   RENDER: HOME TAB
   ══════════════════════════════════════════════════════════════════════════ */

function renderHome() {
  var p = parsed;
  var el = document.getElementById('hc');
  var now = new Date();
  var dim = new Date(viewMonth.getFullYear(), viewMonth.getMonth() + 1, 0).getDate();
  var dom = (viewMonth.getMonth() === now.getMonth() && 
             viewMonth.getFullYear() === now.getFullYear()) ? now.getDate() : dim;
  
  var moPct = Math.round((dom / dim) * 100);
  var budPct = p.totalAssignedAll > 0 ? 
    Math.round((p.totalExp / p.totalAssignedAll) * 100) : 0;
  
  var pace = budPct > moPct + 10 ? 'over' : 
             budPct > moPct - 5 ? 'warn' : 'good';
  var pLbl = pace === 'over' ? 'Over pace' : 
             pace === 'warn' ? 'On watch' : 'On track';
  
  var hs = p.readyToAssign < 0 ? 'neg' : 
           p.readyToAssign < p.totalInc * 0.1 ? 'warn' : 'pos';
  
  var html = '';
  
  // Health sentence
  var monthName = MONTHS[viewMonth.getMonth()];
  var healthMsg, healthClass;
  if (p.readyToAssign < 0) {
    healthMsg = monthName + ' is over-assigned.';
    healthClass = 'neg';
  } else if (pace === 'over') {
    healthMsg = monthName + ' needs a reset.';
    healthClass = 'warn';
  } else if (p.overspent.length > 0) {
    healthMsg = monthName + ' has some overspending.';
    healthClass = 'warn';
  } else if (p.readyToAssign < p.totalInc * 0.05) {
    healthMsg = monthName + ' is fully allocated.';
    healthClass = 'pos';
  } else {
    healthMsg = monthName + ' looks great.';
    healthClass = 'pos';
  }
  
  // Greeting
  html += '<div>' +
    '<div class="home-hey">Hey, Miles.</div>' +
    '<div class="home-sub"><span style="color:var(' + 
    (healthClass === 'pos' ? '--income' : healthClass === 'warn' ? '--warn' : '--expense') + 
    ')">' + healthMsg + '</span></div>' +
    '</div>';
  
  // Overspent alerts
  p.overspent.forEach(function(c) {
    if (dismissed[c.cat]) return;
    html += '<div class="alert e" style="gap:10px">' +
      '<span style="font-size:16px;flex-shrink:0">⚠</span>' +
      '<div class="atxt" style="flex:1">' +
      '<strong style="color:var(--expense);display:block">' + c.cat + ' is overspent</strong>' +
      '<span style="font-size:12px">&#8369;0 left &mdash; over by ' + peso(Math.abs(c.available)) + ' this period</span>' +
      '</div>' +
      '<button class="ax" onclick="dismiss(\'' + esc(c.cat) + '\')">&#215;</button></div>';
  });
  
  // Left to Assign hero
  html += '<div class="hero"><div class="hglow ' + hs + '"></div>' +
    '<div class="hi" style="position:relative;z-index:1">' +
    '<div class="hmlbl">Left to Assign</div>' +
    '<div class="hamt ' + hs + '" style="font-size:44px;margin:4px 0">' +
    (p.readyToAssign < 0 ? '&#8722;' : '') + peso(Math.abs(p.readyToAssign)) + '</div>' +
    '<div class="hero-from">From ' + peso(p.totalInc) + ' income this period</div>' +
    '</div>' +
    '<div class="hstats">' +
    '<div class="hs"><div class="hslbl">Income</div><div class="hsval ic">' + sh(p.totalInc) + '</div></div>' +
    '<div class="hs"><div class="hslbl">Assigned</div><div class="hsval nc">' + sh(p.totalAssignedAll) + '</div></div>' +
    '<div class="hs"><div class="hslbl">Spent</div><div class="hsval ec">' + sh(p.totalExp) + '</div></div>' +
    '</div></div>';
  
  // Spending Pace
  html += '<div class="pace"><div class="pace-hdr">' +
    '<div class="pace-lbl">Spending Pace &mdash; ' + 
    MONTHS[viewMonth.getMonth()].slice(0, 3).toUpperCase() + '</div>' +
    '<div class="pchip ' + pace + '">' + pLbl + '</div></div>' +
    '<div class="prow"><span class="prl">Month progress</span>' +
    '<span class="prv">Day ' + dom + ' of ' + dim + ' &nbsp;' + moPct + '%</span></div>' +
    '<div class="bt"><div class="bf ic" style="width:' + moPct + '%"></div></div>' +
    '<div class="prow"><span class="prl">Budget used</span>' +
    '<span class="prv"><span style="font-weight:700;color:' + 
    (pace === 'over' ? 'var(--expense)' : pace === 'warn' ? 'var(--warn)' : 'var(--income)') + '">' +
    budPct + '%</span> of ' + sh(p.totalAssignedAll) + '</span></div>' +
    '<div class="bt last"><div class="bf ' + 
    (pace === 'over' ? 'ec' : pace === 'warn' ? 'wc' : 'ic') + 
    '" style="width:' + Math.min(budPct, 100) + '%"></div></div>' +
    '</div>';
  
  // Goals
  var goals = p.categories.filter(function(c) {
    return c.group === 'Goals' || c.group === 'Emergency';
  });
  
  if (goals.length) {
    html += '<div class="home-sechdr">' +
      '<span class="home-seclbl">Goals</span>' +
      '<span class="seeall" onclick="switchTab(4)">Manage</span></div>';
    html += '<div class="goals-scroll">';
    
    goals.forEach(function(g) {
      var target = g.yearlyGoal || g.totalAssigned;
      var funded = g.totalAssigned;
      var gpct = target > 0 ? Math.min(Math.round((funded / target) * 100), 100) : 0;
      var remaining = Math.max(target - funded, 0);
      var gclr = gpct >= 100 ? 'var(--income)' : gpct >= 60 ? 'var(--accent)' : 'var(--warn)';
      
      var r = 22;
      var circ = 2 * Math.PI * r;
      var fill = circ * (gpct / 100);
      var gap = circ - fill;
      
      html += '<div class="gcard">' +
        '<div class="gcard-pct">' +
        '<svg class="gcard-svg" viewBox="0 0 56 56">' +
        '<circle cx="28" cy="28" r="' + r + '" fill="none" stroke="var(--surface3)" stroke-width="4"/>' +
        '<circle cx="28" cy="28" r="' + r + '" fill="none" stroke="' + gclr + '" stroke-width="4"' +
        ' stroke-dasharray="' + fill.toFixed(1) + ' ' + gap.toFixed(1) + '" stroke-linecap="round"/>' +
        '</svg>' +
        '<div class="gcard-num" style="color:' + gclr + '">' + gpct + '%</div>' +
        '</div>' +
        '<div class="gcard-name">' + g.cat + '</div>' +
        '<div class="gcard-sub">To go</div>' +
        '<div class="gcard-val" style="color:' + gclr + '">' + peso(remaining) + '</div>' +
        '</div>';
    });
    
    html += '</div>';
  }
  
  // Budget preview
  var budCats = p.categories.filter(function(c) {
    return c.group !== 'Income' && c.group !== 'Goals' && 
           c.group !== 'Emergency' && c.group !== 'Sinking' && 
           c.totalAssigned > 0;
  }).sort(function(a, b) {
    return b.actAmt - a.actAmt;
  }).slice(0, 6);
  
  if (budCats.length) {
    html += '<div class="home-sechdr">' +
      '<span class="home-seclbl">Budget</span>' +
      '<span class="seeall" onclick="switchTab(1)">See all</span></div>';
    html += '<div class="tlist">';
    
    budCats.forEach(function(c) {
      var spentPct = c.totalAssigned > 0 ? 
        Math.min(Math.round((c.actAmt / c.totalAssigned) * 100), 100) : 
        (c.actAmt > 0 ? 100 : 0);
      var bc = c.status === 'over' ? 'over' : c.status === 'warn' ? 'warn' : 'ok';
      var amtCls = c.status === 'over' ? 'neg' : c.status === 'warn' ? 'warn' : 'pos';
      
      html += '<div class="hbudrow" onclick="switchTab(1)">' +
        '<div class="hbudl">' +
        '<div class="hbudname">' + c.cat + '</div>' +
        '<div class="hbudbar"><div class="hbudfill ' + bc + '" style="width:' + spentPct + '%"></div></div>' +
        '</div>' +
        '<div class="hbudr">' +
        '<div class="hbudamt ' + amtCls + '">' + 
        (c.available < 0 ? '&#8722;' : '') + peso(Math.abs(c.available)) + '</div>' +
        '<div class="hbudsub">of ' + sh(c.totalAssigned) + '</div>' +
        '</div>' +
        '</div>';
    });
    
    html += '</div>';
  }
  
  // Recent transactions
  var recent = p.allTxns.slice(0, 5);
  if (recent.length) {
    html += '<div class="home-sechdr">' +
      '<span class="home-seclbl">Recent</span>' +
      '<span class="seeall" onclick="switchTab(2)">All txns</span></div>';
    html += '<div class="tlist">';
    
    recent.forEach(function(t) {
      var cls = t.type === 'income' ? 'income' : 
                t.type === 'transfer' ? 'transfer' : 'expense';
      
      html += '<div class="trow" onclick="switchTab(2)">' +
        '<div class="trowl">' +
        '<div class="trowname">' + (t.merchant || '--') + '</div>' +
        (t.memo ? '<div class="trowmemo">' + t.memo + '</div>' : '') +
        '<div class="trowcat">' + (t.cat || t.group || t.type) + ' &middot; ' + 
        t.payment + ' &middot; ' + fd(t.date) + '</div>' +
        '</div>' +
        '<div class="trowr">' +
        '<div class="trowamt ' + cls + '">' + 
        (t.amount < 0 ? '&#8722;' : '+') + peso(Math.abs(t.amount)) + '</div>' +
        '</div>' +
        '</div>';
    });
    
    html += '</div>';
  }
  
  html += '<div class="ts">' + 
    (lastUp ? 'Updated ' + lastUp.toLocaleTimeString('en-PH', { 
      hour: '2-digit', minute: '2-digit' 
    }) : '') + '</div>';
  
  el.innerHTML = html;
}


/* ══════════════════════════════════════════════════════════════════════════
   RENDER: PLAN TAB
   ══════════════════════════════════════════════════════════════════════════ */

function renderPlan() {
  var p = parsed;
  var el = document.getElementById('pc');
  var lta = p.readyToAssign;
  var hs = lta < 0 ? 'neg' : lta < p.totalInc * 0.15 ? 'warn' : 'pos';
  
  var badge = document.getElementById('planbadge');
  badge.style.display = p.overspent.length ? '' : 'none';
  badge.textContent = p.overspent.length;
  
  var byGrp = {};
  p.categories.forEach(function(item) {
    var g = item.group || 'Other';
    if (!byGrp[g]) byGrp[g] = [];
    byGrp[g].push(item);
  });
  
  Object.keys(byGrp).forEach(function(g) {
    byGrp[g].sort(function(a, b) {
      if (a.status === 'over' && b.status !== 'over') return -1;
      if (b.status === 'over' && a.status !== 'over') return 1;
      return a.available - b.available;
    });
  });
  
  var oGrps = GORDER.filter(function(g) {
    return byGrp[g];
  }).concat(Object.keys(byGrp).filter(function(g) {
    return GORDER.indexOf(g) < 0;
  }));
  
  var html = '';
  
  // Overspent alerts
  p.overspent.forEach(function(c) {
    if (dismissed[c.cat]) return;
    html += '<div class="alert e"><div class="atxt">' +
      '<strong>' + c.cat + ' overspent</strong>' +
      '<span>' + peso(Math.abs(c.available)) + ' over</span></div>' +
      '<button class="ax" onclick="dismiss(\'' + esc(c.cat) + '\')">&#215;</button></div>';
  });
  
  // Left to Assign hero
  html += '<div class="hero"><div class="hglow ' + hs + '"></div><div class="hi">' +
    '<div class="hmlbl">Left to Assign</div>' +
    '<div style="display:flex;justify-content:space-between;align-items:flex-start">' +
    '<div class="hamt ' + hs + '">' + 
    (lta < 0 ? '&#8722;' : '') + peso(Math.abs(lta)) + '</div>' +
    '<div class="hchip ' + hs + '">' + 
    (lta < 0 ? 'Over-assigned' : lta < p.totalInc * 0.15 ? 'Low' : 'On track') + 
    '</div>' +
    '</div></div><div class="hstats" style="margin-top:12px">' +
    '<div class="hs"><div class="hslbl">Income</div><div class="hsval ic">' + sh(p.totalInc) + '</div></div>' +
    '<div class="hs"><div class="hslbl">Spent</div><div class="hsval ec">' + sh(p.totalExp) + '</div></div>' +
    '<div class="hs"><div class="hslbl">Assigned</div><div class="hsval nc">' + sh(p.totalAssignedAll) + '</div></div>' +
    '</div></div>';
  
  // Summary bar
  var sumPct = p.totalAssignedAll > 0 ? 
    Math.min(Math.round((p.totalExp / p.totalAssignedAll) * 100), 999) : 0;
  var sumClr = sumPct > 100 ? 'var(--expense)' : 
               sumPct > 80 ? 'var(--warn)' : 'var(--accent)';
  
  html += '<div class="sumbar"><div class="sumbar-row">' +
    '<span class="sumbar-lbl">Total Assigned vs Activity</span>' +
    '<span class="sumbar-val">' + peso(p.totalAssignedAll) + '</span></div>' +
    '<div class="sumbar-track" style="height:6px;background:var(--surface3);' +
    'border-radius:3px;overflow:hidden;position:relative">' +
    '<div style="position:absolute;top:0;left:0;height:100%;width:100%;' +
    'background:rgba(42,157,159,.18);border-radius:3px"></div>' +
    '<div style="position:absolute;top:0;left:0;height:100%;width:' + 
    Math.min(sumPct, 100) + '%;border-radius:3px;background:' + sumClr + 
    ';transition:width .6s"></div>' +
    '</div><div class="sumbar-sub">' +
    '<span class="sumbar-sublbl">Activity ' + sumPct + '%</span>' +
    '<span class="sumbar-subval">&#8722;' + peso(p.totalExp) + '</span>' +
    '</div></div>';
  
  // Search
  html += '<div class="sw"><span class="sico">&#9906;</span>' +
    '<input class="si" id="catq" placeholder="Search categories..." ' +
    'oninput="filterCats(this.value)"></div>';
  
  // Groups
  var delay = 0;
  oGrps.forEach(function(grp) {
    var items = byGrp[grp];
    if (!items || !items.length) return;
    
    var gAv = items.reduce(function(s, i) { return s + i.available; }, 0);
    var gCls = gAv < 0 ? 'neg' : gAv > 0 ? 'pos' : 'zero';
    var gid = 'g_' + grp.replace(/\W+/g, '_');
    
    html += '<div class="grp"><div class="grphdr" onclick="togGrp(\'' + gid + '\')">' +
      '<div class="grptitle"><span class="grptog" id="gt_' + gid + '">&#9662;</span>' + 
      grp + '</div>' +
      '<div class="grpav ' + gCls + '">' + 
      (gAv < 0 ? '&#8722;' : '') + sh(Math.abs(gAv)) + '</div></div>' +
      '<div class="grpcats" id="gc_' + gid + '">';
    
    items.forEach(function(c) {
      var pid = 'dp_' + c.cat.replace(/\W+/g, '_');
      var bCls = c.status === 'over' ? 'over' : 
                 c.status === 'warn' ? 'warn' : 'ok';
      
      var actW = c.totalAssigned > 0 ? 
        Math.min(Math.round((c.actAmt / c.totalAssigned) * 100), 100) : 
        (c.actAmt > 0 ? 100 : 0);
      
      html += '<div class="cat ' + c.status + '" style="animation-delay:' + delay + 'ms" ' +
        'onclick="togDet(\'' + pid + '\')">' +
        '<div class="cattop"><div class="catl"><div class="catname">' + c.cat + '</div>' +
        '<div class="catsub">' + 
        (c.totalAssigned > 0 ? peso(c.totalAssigned) + ' budgeted' : 'no budget') +
        (c.txns.length ? ' &middot; ' + c.txns.length + ' txn' + 
          (c.txns.length !== 1 ? 's' : '') : '') + '</div></div>' +
        '<div class="catr"><div class="catav ' + 
        (c.available < 0 ? 'neg' : c.available === 0 ? 'zero' : 'pos') + '">' +
        (c.available < 0 ? '&#8722;' : '') + peso(Math.abs(c.available)) + '</div>' +
        (c.actAmt > 0 ? '<div class="catsp">&#8722;' + sh(c.actAmt) + ' spent</div>' : '') +
        '</div></div>' +
        
        // Progress bar — full-width track, activity fill
        '<div class="catbarwrap">' +
        '<div class="catbarlbls"><span>' + 
        (c.totalAssigned > 0 ? sh(c.actAmt) + ' / ' + sh(c.totalAssigned) : 'no budget') + 
        '</span><span>' + 
        (c.totalAssigned > 0 ? Math.round(c.pct) + '%' : '') + '</span></div>' +
        '<div class="catbartrack">' +
        '<div class="catbaract ' + bCls + '" style="width:' + actW + '%"></div>' +
        '</div></div>' +
        
        // Detail panel
        '<div class="det" id="' + pid + '"><div class="detin">' +
        '<div class="detgrid">' +
        '<div class="dstat"><div class="dslbl">Assigned</div>' +
        '<div class="dsval n">' + peso(c.assigned) + '</div></div>' +
        '<div class="dstat"><div class="dslbl">Activity</div>' +
        '<div class="dsval ' + (c.actAmt > 0 ? 'neg' : 'n') + '">' + 
        (c.actAmt > 0 ? '&#8722;' : '') + peso(c.actAmt) + '</div></div>' +
        '<div class="dstat"><div class="dslbl">Available</div>' +
        '<div class="dsval ' + (c.available < 0 ? 'neg' : c.available === 0 ? 'n' : 'pos') + '">' +
        (c.available < 0 ? '&#8722;' : '') + peso(Math.abs(c.available)) + '</div></div>' +
        ((['Sinking', 'Emergency', 'Goals'].indexOf(c.group) >= 0) ?
          '<div class="dstat"><div class="dslbl">Monthly Goal</div>' +
          '<div class="dsval n">' + (c.monthlyGoal > 0 ? peso(c.monthlyGoal) : '—') + '</div></div>' :
          '<div class="dstat"><div class="dslbl">Rollover</div>' +
          '<div class="dsval ' + (c.rollover > 0 ? 'pos' : 'n') + '">' + peso(c.rollover) + '</div></div>') +
        '</div>' +
        
        // BvA bar
        '<div class="bvabarsec">' +
        '<div class="bvalblrow"><span class="bvalbl">Budgeted vs Activity</span>' +
        '<span class="bvaval ' + (c.available < 0 ? 'ec' : c.available === 0 ? 'nc' : 'ic') + '">' +
        (c.totalAssigned > 0 ? Math.round(c.pct) + '% used' : 'no budget') + '</span></div>' +
        '<div class="bvatrack">' +
        '<div class="bvaassigned" style="width:100%"></div>' +
        '<div class="bvaact ' + bCls + '" style="width:' + Math.round(c.pct) + '%"></div>' +
        '</div>' +
        '<div class="bvasubrow">' +
        '<span class="bvasubl">Activity ' + peso(c.actAmt) + '</span>' +
        '<span class="bvasubl">Budgeted ' + peso(c.totalAssigned) + '</span></div>' +
        '</div>' +
        
        // Transactions
        (c.txns.length ?
          '<div class="dettitle">Transactions &middot; ' + c.txns.length + '</div>' +
          c.txns.map(function(t, i) {
            return '<div class="dtxn"><div class="txn-idx">' + (i + 1) + '</div>' +
              '<div class="dtxnl">' +
              '<div class="dtxnname">' + (t.merchant || '--') + '</div>' +
              (t.memo ? '<div class="dtxnmemo">' + t.memo + '</div>' : '') +
              '<div class="dtxnmeta">' + fd(t.date) + ' &middot; ' + t.payment + '</div>' +
              '</div><div class="dtxnamt e">&#8722;' + peso(Math.abs(t.amount)) + 
              '</div></div>';
          }).join('')
          : '<div class="dtxnempty">No transactions this month</div>') +
        '</div></div></div>';
      
      delay += 16;
    });
    
    html += '</div></div>';
  });
  
  html += '<div class="ts">' + 
    (lastUp ? 'Updated ' + lastUp.toLocaleTimeString('en-PH', { 
      hour: '2-digit', minute: '2-digit' 
    }) : '') + '</div>';
  
  el.innerHTML = html;
}

function togGrp(id) {
  var cats = document.getElementById('gc_' + id);
  var tog = document.getElementById('gt_' + id);
  if (!cats) return;
  
  var c = cats.classList.toggle('coll');
  cats.style.maxHeight = c ? '' : cats.scrollHeight + 'px';
  if (tog) tog.classList.toggle('coll', c);
}

function togDet(id) {
  var det = document.getElementById(id);
  if (!det) return;
  
  var wasOpen = det.classList.contains('open');
  document.querySelectorAll('.det.open').forEach(function(d) {
    d.classList.remove('open');
  });
  
  if (!wasOpen) det.classList.add('open');
  haptic();
}

function dismiss(cat) {
  dismissed[cat] = true;
  document.querySelectorAll('.alert').forEach(function(el) {
    var s = el.querySelector('strong');
    if (s && s.textContent.indexOf(cat) >= 0) el.remove();
  });
}

function filterCats(q) {
  var low = q.toLowerCase();
  document.querySelectorAll('.cat').forEach(function(el) {
    var n = (el.querySelector('.catname') || {}).textContent || '';
    el.style.display = n.toLowerCase().indexOf(low) >= 0 ? '' : 'none';
  });
  document.querySelectorAll('.grp').forEach(function(el) {
    var any = [].slice.call(el.querySelectorAll('.cat')).some(function(c) {
      return c.style.display !== 'none';
    });
    el.style.display = any ? '' : 'none';
  });
}


/* ══════════════════════════════════════════════════════════════════════════
   RENDER: SPENDING TAB
   ══════════════════════════════════════════════════════════════════════════ */

function renderSpend() {
  var p = parsed;
  var el = document.getElementById('sc2');
  
  var catSet = ['All'];
  p.allTxns.filter(function(t) {
    return t.type === 'expense' && t.cat;
  }).forEach(function(t) {
    if (catSet.indexOf(t.cat) < 0) catSet.push(t.cat);
  });
  catSet.sort(function(a, b) {
    return a === 'All' ? -1 : a.localeCompare(b);
  });
  
  var txns = p.allTxns.filter(function(t) {
    return t.type !== 'balance';
  });
  
  if (spendFilter !== 'All') {
    txns = txns.filter(function(t) {
      return t.cat === spendFilter;
    });
  }
  
  var total = txns.filter(function(t) {
    return t.type === 'expense';
  }).reduce(function(s, t) {
    return s + Math.abs(t.amount);
  }, 0);
  
  var html = '<div class="chips">';
  catSet.slice(0, 14).forEach(function(c) {
    html += '<div class="chip' + (c === spendFilter ? ' active' : '') + '" ' +
      'onclick="setSF(\'' + esc(c) + '\')">' + c + '</div>';
  });
  html += '</div>';
  
  html += '<div class="hero" style="padding:14px 16px"><div class="hglow neg"></div>' +
    '<div class="hi">' +
    '<div class="hmlbl">' + (spendFilter === 'All' ? 'Total Spent' : spendFilter) + '</div>' +
    '<div class="hamt neg" style="font-size:26px">' + peso(total) + '</div></div></div>';
  
  html += buildTGs(txns);
  
  html += '<div class="ts">' + 
    (lastUp ? 'Updated ' + lastUp.toLocaleTimeString('en-PH', { 
      hour: '2-digit', minute: '2-digit' 
    }) : '') + '</div>';
  
  el.innerHTML = html;
}

function setSF(cat) {
  spendFilter = cat;
  renderSpend();
  document.getElementById('p2').scrollTop = 0;
}

function buildTGs(txns) {
  if (!txns.length) return '<div class="tempty">No transactions</div>';
  
  var byDate = {};
  var keys = [];
  
  txns.forEach(function(t) {
    var key = t.date ? 
      t.date.toLocaleDateString('en-PH', { 
        month: 'short', day: 'numeric', year: 'numeric' 
      }) : '--';
    if (!byDate[key]) {
      byDate[key] = { txns: [], date: t.date };
      keys.push(key);
    }
    byDate[key].txns.push(t);
  });
  
  return keys.map(function(dk, gi) {
    var g = byDate[dk];
    var dt = g.txns.reduce(function(s, t) {
      return s + t.amount;
    }, 0);
    
    return '<div class="dg"><div class="dghdr"><span class="dglbl">' + dk + '</span>' +
      '<span class="dgtot ' + (dt < 0 ? 'neg' : 'pos') + '">' +
      (dt < 0 ? '&#8722;' : '+') + peso(Math.abs(dt)) + '</span></div>' +
      '<div class="tlist">' +
      g.txns.map(function(t, i) {
        var cls = t.type === 'income' ? 'income' : 
                  t.type === 'transfer' ? 'transfer' : 'expense';
        return '<div class="trow" style="animation-delay:' + ((gi * 4 + i) * 12) + 'ms">' +
          '<div class="trowl"><div class="trowname">' + (t.merchant || '--') + '</div>' +
          (t.memo ? '<div class="trowmemo">' + t.memo + '</div>' : '') +
          '<div class="trowcat">' + (t.cat || t.group || '--') + '</div></div>' +
          '<div class="trowr"><div class="trowamt ' + cls + '">' +
          (t.amount < 0 ? '&#8722;' : '+') + peso(Math.abs(t.amount)) + '</div>' +
          '<div class="trowvia">' + t.payment + '</div></div></div>';
      }).join('') + '</div></div>';
  }).join('');
}


/* ══════════════════════════════════════════════════════════════════════════
   RENDER: ACCOUNTS TAB
   ══════════════════════════════════════════════════════════════════════════ */

function renderAccounts() {
  var p = parsed;
  var el = document.getElementById('ac');
  
  if (accDet) {
    renderAccDet(accDet);
    return;
  }
  
  var nw = p.netWorth;
  var momAmt = p.prevCashEnd > 0 ? nw - p.prevCashEnd : 0;
  var momPct = p.prevCashEnd > 0 ? (momAmt / Math.abs(p.prevCashEnd)) * 100 : 0;
  var momClr = momAmt >= 0 ? 'var(--income)' : 'var(--expense)';
  
  var html = '<div class="nw"><div class="nwlbl">Net Worth</div>' +
    '<div class="nwamt ' + (nw >= 0 ? 'pos' : 'neg') + '">' +
    (nw < 0 ? '&#8722;' : '') + peso(Math.abs(nw)) + '</div>';
  
  if (momAmt !== 0) {
    html += '<div class="nwsub" style="color:' + momClr + '">' +
      (momAmt >= 0 ? '+' : '&#8722;') + peso(Math.abs(momAmt)) +
      ' (' + (momAmt >= 0 ? '+' : '') + momPct.toFixed(1) + '%) from last month</div>';
  } else {
    html += '<div class="nwsub">Total across all accounts</div>';
  }
  html += '</div>';
  
  html += '<div class="lbl">Accounts</div><div class="accs">';
  
  ACCOUNTS.forEach(function(acc) {
    var snap = p.accountSnap[acc];
    var bal = snap ? snap.cashEnd : (p.accBals[acc] || 0);
    var txns = p.txnsByAcc[acc] || [];
    var bc = bal > 0 ? 'pos' : bal < 0 ? 'neg' : 'zero';
    
    html += '<div class="accrow" onclick="openAccDet(\'' + acc + '\')">' +
      '<div class="accl"><div class="accname">' + acc + '</div>';
    
    if (snap) {
      var actClr = snap.activity >= 0 ? 'var(--income)' : 'var(--expense)';
      html += '<div class="accmeta">' +
        '<span style="color:' + actClr + '">' +
        (snap.activity >= 0 ? '+' : '&#8722;') + peso(Math.abs(snap.activity)) +
        '</span> &nbsp;&middot;&nbsp; ' + txns.length + ' txn' + (txns.length !== 1 ? 's' : '') +
        '</div>';
    } else {
      html += '<div class="accmeta">' + txns.length + ' txn' + 
        (txns.length !== 1 ? 's' : '') + ' this month</div>';
    }
    
    html += '</div>' +
      '<div class="accr"><div class="accbal ' + bc + '">' +
      (bal < 0 ? '&#8722;' : '') + peso(Math.abs(bal)) + '</div>' +
      '<div class="accchev">&#8250;</div></div></div>';
  });
  
  html += '</div><div class="ts">' + 
    (lastUp ? 'Updated ' + lastUp.toLocaleTimeString('en-PH', { 
      hour: '2-digit', minute: '2-digit' 
    }) : '') + '</div>';
  
  el.innerHTML = html;
}

function openAccDet(acc) {
  accDet = { account: acc, filter: 'all' };
  renderAccDet(accDet);
  haptic();
}

function renderAccDet(mode) {
  var p = parsed;
  var el = document.getElementById('ac');
  var acc = mode.account;
  var flt = mode.filter;
  
  var snap = p.accountSnap[acc];
  var bal = snap ? snap.cashEnd : (p.accBals[acc] || 0);
  var all = p.txnsByAcc[acc] || [];
  var txns = flt === 'income' ? 
    all.filter(function(t) { return t.type === 'income'; }) : 
    flt === 'expense' ? 
    all.filter(function(t) { return t.type === 'expense'; }) : all;
  
  var header = '<div class="back" onclick="closeAccDet()">' +
    '<span style="font-size:18px">&#8249;</span>' + acc + '</div>' +
    '<div class="nw" style="border-radius:14px;padding:14px 16px">' +
    '<div class="nwlbl">Balance</div>' +
    '<div class="nwamt ' + (bal >= 0 ? 'pos' : 'neg') + '" style="font-size:24px">' +
    (bal < 0 ? '&#8722;' : '') + peso(Math.abs(bal)) + '</div>';
  
  if (snap) {
    var actClr = snap.activity >= 0 ? 'var(--income)' : 'var(--expense)';
    header += '<div class="nwsub" style="margin-top:6px;display:flex;gap:14px">' +
      '<span>Started ' + peso(snap.cashStart) + '</span>' +
      '<span style="color:' + actClr + '">' +
      (snap.activity >= 0 ? '+' : '&#8722;') + peso(Math.abs(snap.activity)) + ' activity' +
      '</span></div>';
  }
  header += '</div>';
  
  el.innerHTML = header +
    '<div class="afbar">' +
    '<div class="afc' + (flt === 'all' ? ' active' : '') + '" ' +
    'onclick="setAF(\'' + acc + '\',\'all\')">All</div>' +
    '<div class="afc' + (flt === 'income' ? ' active' : '') + '" ' +
    'onclick="setAF(\'' + acc + '\',\'income\')">Income</div>' +
    '<div class="afc' + (flt === 'expense' ? ' active' : '') + '" ' +
    'onclick="setAF(\'' + acc + '\',\'expense\')">Expenses</div>' +
    '</div>' + buildTGs(txns) +
    '<div class="ts">' + 
    (lastUp ? 'Updated ' + lastUp.toLocaleTimeString('en-PH', { 
      hour: '2-digit', minute: '2-digit' 
    }) : '') + '</div>';
}

function setAF(acc, flt) {
  accDet = { account: acc, filter: flt };
  renderAccDet(accDet);
}

function closeAccDet() {
  accDet = null;
  renderAccounts();
}


/* ══════════════════════════════════════════════════════════════════════════
   RENDER: MORE TAB
   ══════════════════════════════════════════════════════════════════════════ */

function renderMore() {
  var p = parsed;
  var el = document.getElementById('mc');
  var sinking = p.categories.filter(function(c) {
    return c.group === 'Sinking';
  });
  var goals = p.categories.filter(function(c) {
    return c.group === 'Goals';
  });
  
  var html = '';
  
  // Budget vs Activity
  html += '<div class="lbl">Budget vs Activity</div><div class="more">';
  var byGrp2 = {};
  p.categories.filter(function(c) {
    return c.group !== 'Income';
  }).forEach(function(c) {
    if (!byGrp2[c.group]) byGrp2[c.group] = [];
    byGrp2[c.group].push(c);
  });
  
  var gkeys = GORDER.filter(function(g) {
    return byGrp2[g];
  }).concat(Object.keys(byGrp2).filter(function(g) {
    return GORDER.indexOf(g) < 0;
  }));
  
  gkeys.forEach(function(gname) {
    var items = byGrp2[gname];
    if (!items || !items.length) return;
    
    var gTA = items.reduce(function(s, i) { return s + i.totalAssigned; }, 0);
    var gAct = items.reduce(function(s, i) { return s + i.actAmt; }, 0);
    
    html += '<div style="padding:10px 14px 8px;border-bottom:1px solid var(--border)">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">' +
      '<span style="font-family:\'Syne\',sans-serif;font-size:12px;font-weight:700;' +
      'color:var(--text2)">' + gname + '</span>' +
      '<span style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted)">' +
      sh(gAct) + ' / ' + sh(gTA) + '</span></div>';
    
    items.forEach(function(c) {
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">' +
        '<div style="font-size:12px;flex:1;min-width:0;white-space:nowrap;' +
        'overflow:hidden;text-overflow:ellipsis">' + c.cat + '</div>' +
        '<div style="flex-shrink:0;width:80px;height:4px;background:var(--surface3);' +
        'border-radius:2px;overflow:hidden;position:relative">' +
        '<div style="position:absolute;top:0;left:0;height:100%;width:100%;' +
        'background:rgba(42,157,159,.18);border-radius:2px"></div>' +
        '<div style="position:absolute;top:0;left:0;height:100%;width:' + 
        Math.round(c.pct) + '%;border-radius:2px;background:' + 
        (c.status === 'over' ? 'var(--expense)' : c.status === 'warn' ? 'var(--warn)' : 'var(--accent)') + 
        '"></div>' +
        '</div>' +
        '<div style="font-family:\'DM Mono\',monospace;font-size:10px;width:50px;' +
        'text-align:right;font-variant-numeric:tabular-nums;color:' + 
        (c.available < 0 ? 'var(--expense)' : c.available === 0 ? 'var(--muted)' : 'var(--income)') + '">' +
        (c.available < 0 ? '&#8722;' : '') + sh(Math.abs(c.available)) + '</div>' +
        '</div>';
    });
    
    html += '</div>';
  });
  html += '</div>';
  
  // Top Spends
  html += '<div class="lbl">Top Spends</div><div class="more">';
  if (p.top5.length) {
    p.top5.forEach(function(t, i) {
      html += '<div class="t5r"><div class="t5rank">' + (i + 1) + '</div>' +
        '<div class="t5l">' +
        '<div class="t5n">' + (t.merchant || '--') + '</div>' +
        '<div class="t5c">' + (t.memo || t.cat) + '</div></div>' +
        '<div class="t5a">&#8722;' + peso(t.amount) + '</div></div>';
    });
  } else {
    html += '<div style="padding:20px;text-align:center;font-size:12px;color:var(--muted)">' +
      'No transactions</div>';
  }
  html += '</div>';
  
  // By Merchant
  html += '<div class="lbl">By Merchant</div><div class="more">';
  if (p.merch.length) {
    p.merch.forEach(function(m) {
      html += '<div class="mr2"><div class="mr2n">' + m.name + '</div>' +
        '<div class="mr2r">' +
        '<div class="mr2a">&#8722;' + peso(m.total) + '</div>' +
        '<div class="mr2c">' + m.count + ' txn' + (m.count !== 1 ? 's' : '') + '</div>' +
        '</div></div>';
    });
  } else {
    html += '<div style="padding:20px;text-align:center;font-size:12px;color:var(--muted)">' +
      'No data</div>';
  }
  html += '</div>';
  
  // Sinking Funds
  if (sinking.length) {
    html += '<div class="lbl">Sinking Funds</div><div class="more">';
    sinking.forEach(function(c) {
      var pct = c.totalAssigned > 0 ? 
        Math.min((c.available / c.totalAssigned) * 100, 100) : 0;
      html += '<div class="mrow"><div class="mrowl"><div class="mrowname">' + c.cat + '</div>' +
        '<div class="mrowsub">' + peso(c.available) + ' saved &middot; ' + 
        peso(c.totalAssigned) + '/mo</div></div>' +
        '<div class="mrowr"><div class="mamount ' + 
        (c.available < 0 ? 'neg' : 'pos') + '">' + sh(c.available) + '</div>' +
        '<div class="gbar"><div class="gfill' + (pct >= 100 ? ' full' : '') + '" ' +
        'style="width:' + Math.max(0, pct) + '%"></div></div>' +
        '</div></div>';
    });
    html += '</div>';
  }
  
  // Goals
  if (goals.length) {
    html += '<div class="lbl">Goals</div><div class="more">';
    goals.forEach(function(c) {
      var pct = c.goal > 0 ? Math.min((c.available / c.goal) * 100, 100) : 0;
      var left = c.goal > 0 && c.available < c.goal ? 
        Math.ceil((c.goal - c.available) / (c.goal / 12)) : 0;
      html += '<div class="mrow"><div class="mrowl"><div class="mrowname">' + c.cat + '</div>' +
        '<div class="mrowsub">' + peso(c.available) + ' of ' + peso(c.goal) + 
        (left > 0 ? ' &middot; ~' + left + 'mo' : ' &middot; funded') + '</div></div>' +
        '<div class="mrowr"><div class="mamount ' + (pct >= 100 ? 'pos' : 'n') + '">' + 
        Math.round(pct) + '%</div>' +
        '<div class="gbar"><div class="gfill' + (pct >= 100 ? ' full' : '') + '" ' +
        'style="width:' + Math.max(0, pct) + '%"></div></div>' +
        '</div></div>';
    });
    html += '</div>';
  }
  
  html += '<div class="ts">' + 
    (lastUp ? 'Updated ' + lastUp.toLocaleTimeString('en-PH', { 
      hour: '2-digit', minute: '2-digit' 
    }) : '') + '</div>';
  
  el.innerHTML = html;
}


/* ══════════════════════════════════════════════════════════════════════════
   DEBUG PANEL
   ══════════════════════════════════════════════════════════════════════════ */

function toggleDbg() {
  dbgOpen = !dbgOpen;
  document.getElementById('dbgpanel').classList.toggle('hidden', !dbgOpen);
  document.getElementById('dbgbtn').classList.toggle('on', dbgOpen);
  if (dbgOpen && parsed) renderDbg();
}

function switchDbgTab(i) {
  dbgTab = i;
  document.querySelectorAll('.dbgtab').forEach(function(t, j) {
    t.classList.toggle('active', j === i);
  });
  if (parsed) renderDbg();
}

function renderDbg() {
  var el = document.getElementById('dbgbody');
  if (!rawB) {
    el.innerHTML = '<div class="dbgempty">No data loaded yet.</div>';
    return;
  }
  
  var dbg = parsed._dbg;
  var p = parsed;
  
  if (dbgTab === 0) {
    // Overview
    el.innerHTML = '<div class="dbgsec"><div class="dbgst">Parser Health</div>' +
      [
        ['Budget header?', dbg.bHdr, 'bool'],
        ['Activity header?', dbg.aHdr, 'bool'],
        ['Snapshot header?', dbg.sHdr, 'bool'],
        ['AccountSnapshot?', dbg.hasAccSnap, 'bool'],
        ['Raw Budget rows', dbg.rawB, 'num'],
        ['Raw Activity rows', dbg.rawA, 'num'],
        ['Budget this month', dbg.bMo, 'w0'],
        ['Activity this month', dbg.aMo, 'w0'],
        ['Categories', dbg.cats, 'w0'],
        ['Expense txns', dbg.expCt, 'num'],
        ['Income txns', dbg.incCt, 'num'],
        ['Balance rows', dbg.balCt, 'w0']
      ].map(function(c) {
        var cls = c[2] === 'bool' ? (c[1] ? 'ok' : 'bad') : 
                  c[2] === 'w0' ? (c[1] === 0 ? 'bad' : 'ok') : '';
        return '<div class="dbgrow"><span class="dbgk">' + c[0] + '</span>' +
          '<span class="dbgv ' + cls + '">' + 
          (c[1] === true ? 'yes' : c[1] === false ? 'no' : String(c[1])) + 
          '</span></div>';
      }).join('') +
      '</div><div class="dbgsec"><div class="dbgst">Key Values</div><div class="dbggrid">' +
      [
        ['Left to Assign', peso(p.readyToAssign), 'Snapshot col G'],
        ['Total Income', peso(p.totalInc), 'Activity Income txns'],
        ['Total Expense', peso(p.totalExp), 'Activity Expense txns'],
        ['Total Assigned', peso(p.totalAssignedAll), 'Budget col L (11) sum'],
        ['Net Worth', peso(p.netWorth), 'Latest Balance rows'],
        ['Assigned This Mo', peso(p.assignedThisMonth), 'Snapshot col D']
      ].map(function(x) {
        return '<div class="dbgstat"><div class="dbgslbl">' + x[0] + '</div>' +
          '<div class="dbgsval">' + x[1] + '</div>' +
          '<div style="font-size:9px;color:var(--muted);margin-top:1px">' + x[2] + '</div></div>';
      }).join('') +
      '</div></div>' +
      '<div class="dbgsec"><div class="dbgst">Account Balances</div>' +
      ACCOUNTS.map(function(a) {
        var b = p.accBals[a];
        return '<div class="dbgrow"><span class="dbgk">' + a + '</span>' +
          '<span class="dbgv ' + (b > 0 ? 'ok' : b < 0 ? 'bad' : '') + '">' +
          (b < 0 ? '&#8722;' : '') + peso(Math.abs(b)) + '</span></div>';
      }).join('') +
      '</div>';
      
  } else if (dbgTab === 1) {
    // Budget
    var s = p._bRows.slice(0, 5);
    el.innerHTML = '<div class="dbgsec"><div class="dbgst">Budget Column Map</div>' +
      [
        ['5 (F)', 'MonthStart (date filter)'],
        ['6 (G)', 'Group'],
        ['7 (H)', 'Category'],
        ['8 (I)', 'Monthly Goal'],
        ['10 (K)', 'Assigned (manual)'],
        ['11 (L)', 'AssignedThisMonth / Budgeted (incl. rollovers) ✅'],
        ['12 (M)', 'Activity (negative = spent) ✅'],
        ['14 (O)', 'AvailableThisMonth (hero)'],
        ['15 (P)', 'Overspent']
      ].map(function(x) {
        return '<div class="dbgrow"><span class="dbgk">Col ' + x[0] + '</span>' +
          '<span class="dbgv">' + x[1] + '</span></div>';
      }).join('') +
      '</div><div class="dbgsec"><div class="dbgst">First 5 Budget Rows This Month</div>' +
      (s.length === 0 ? '<div class="dbgempty">No rows - check MonthStart parsing</div>' :
        s.map(function(row, i) {
          var pd = parseDate(row[5]);
          return '<div class="dbgrow" style="flex-direction:column;gap:3px;align-items:flex-start">' +
            '<span class="dbgk">Row ' + (i + 1) + ': ' + String(row[7] || '?') + 
            ' / ' + String(row[6] || '?') + '</span>' +
            '<span class="dbgv" style="font-size:9px;text-align:left">' +
            'MonthStart(5): ' + String(row[5] || '--') + ' &rarr; ' + 
            (pd ? pd.toLocaleDateString() : 'FAIL') + '<br>' +
            'TotalAssigned(11): ' + String(row[11] || 0) + ' Activity(12): ' + String(row[12] || 0) + '<br>' +
            'Available(14): ' + String(row[14] || 0) + '</span></div>';
        }).join('') +
        '<div class="dbgnote">Col 11 = AssignedThisMonth (Budgeted), Col 12 = Activity (spent)</div>') +
      '</div>';
      
  } else if (dbgTab === 2) {
    // Activity
    var s2 = p._mAct.slice(0, 6);
    el.innerHTML = '<div class="dbgsec"><div class="dbgst">Activity Column Map</div>' +
      [
        ['0 (A)', 'Date (used for month filter)'],
        ['1 (B)', 'Type'],
        ['2 (C)', 'Amount (neg=expense)'],
        ['3 (D)', 'Merchant'],
        ['4 (E)', 'Payment Method'],
        ['5 (F)', 'Category'],
        ['6 (G)', 'Group'],
        ['7 (H)', 'Memo'],
        ['11 (L)', 'MonthStart label (NOT used for filtering)']
      ].map(function(x) {
        return '<div class="dbgrow"><span class="dbgk">Col ' + x[0] + '</span>' +
          '<span class="dbgv">' + x[1] + '</span></div>';
      }).join('') +
      '</div><div class="dbgsec"><div class="dbgst">First 6 Activity Rows This Month</div>' +
      (s2.length === 0 ? '<div class="dbgempty">No rows - check date parsing</div>' :
        s2.map(function(row, i) {
          var pd = parseDate(row[0]);
          return '<div class="dbgrow" style="flex-direction:column;gap:3px;align-items:flex-start">' +
            '<span class="dbgk">Row ' + (i + 1) + ': ' + String(row[1] || '?') + 
            ' &mdash; ' + String(row[3] || '?') + '</span>' +
            '<span class="dbgv" style="font-size:9px;text-align:left">' +
            'Date(0): ' + String(row[0] || '--') + ' &rarr; ' + 
            (pd ? pd.toLocaleDateString() : 'FAIL') + '<br>' +
            'Amount(2): ' + String(row[2] || 0) + ' Payment(4): ' + String(row[4] || '--') + '<br>' +
            'Cat(5): ' + String(row[5] || '--') + ' Group(6): ' + String(row[6] || '--') + '<br>' +
            'Memo(7): ' + String(row[7] || '--') + '</span></div>';
        }).join('') +
        '<div class="dbgnote">Month filter uses col 0 Date. Memo is col 7 (H).</div>') +
      '</div>';
      
  } else if (dbgTab === 3) {
    // Snapshot
    el.innerHTML = '<div class="dbgsec"><div class="dbgst">Snapshot Column Map</div>' +
      [
        ['0 (A)', 'MonthStart'],
        ['1 (B)', 'CashStart'],
        ['2 (C)', 'InflowExternal'],
        ['3 (D)', 'AssignedThisMonth'],
        ['4 (E)', 'OutflowExternal'],
        ['5 (F)', 'CashEnd'],
        ['6 (G)', 'ReadyToAssignEnd (hero value)']
      ].map(function(x) {
        return '<div class="dbgrow"><span class="dbgk">Col ' + x[0] + '</span>' +
          '<span class="dbgv">' + x[1] + '</span></div>';
      }).join('') +
      '</div><div class="dbgsec"><div class="dbgst">All Snapshot Rows</div>' +
      (p._sData.length === 0 ? '<div class="dbgempty">No rows</div>' :
        p._sData.map(function(row) {
          var dt = parseDate(row[0]);
          var cur = dt && dt.getMonth() === viewMonth.getMonth() && 
                    dt.getFullYear() === viewMonth.getFullYear();
          return '<div class="dbgrow" style="flex-direction:column;gap:3px;align-items:flex-start;' +
            (cur ? 'background:var(--accent-dim);' : '') + '">' +
            '<span class="dbgk">' + String(row[0] || '?') + (cur ? ' (current)' : '') + '</span>' +
            '<span class="dbgv" style="font-size:9px;text-align:left">' +
            'Parsed: ' + (dt ? dt.toLocaleDateString() : 'FAIL') + 
            ' | RTA(G): <strong style="color:var(--warn)">' + String(row[6] || '--') + 
            '</strong></span></div>';
        }).join('') +
        '<div class="dbgnote">Col G ReadyToAssignEnd = hero card</div>') +
      '</div>';
  }
}


/* ══════════════════════════════════════════════════════════════════════════
   BOOT
   ══════════════════════════════════════════════════════════════════════════ */

setML();
if (!loadCache()) {
  loadData();
} else {
  loadData();
}

</script>
</body>
</html>
